---
- name: Install Packages
  block:
    - name: Install Package
      kewlfft.aur.aur:
        name: "{{ item }}"
        state: present
        use: "{{ pacman.aur_helper }}"
      become: false
      loop:
        - hyprcursor
        - hyprlang
        - hyprutils-git
        - hyprwayland-scanner-git
        - hyprland
        - hypridle
        - hyprlock
        - xdg-desktop-portal-hyprland
        - playerctl
        - polkit-gnome
        # plugin dependencies
        - cmake
        - cpio
        - "{{ icons.cursor_icons_package }}"
        - "{{ icons.system_icons_package }}"
        - hyprpicker
        # hyprshade
        - hyprsunset-git

- name: Test Hyprpm After Installation and Rebuild If Necessary
  block:
    - name: Update hyprpm package list
      command: hyprpm update
      when: system.hyprland.plugins.rebuild_hypr_on_failure.enabled and system.hyprland.plugins.rebuild_hypr_on_failure.pkgbuild_url is defined
      changed_when: no

  rescue:
    - name: Rebuild Hyprland
      ansible.builtin.shell:
        cmd: |
          mkdir {{ ansible_user_dir }}/hyprland_rebuild
          cd {{ ansible_user_dir }}/hyprland_rebuild
          /usr/bin/curl -fsSL {{ system.hyprland.plugins.rebuild_hypr_on_failure.pkgbuild_url }} > PKGBUILD
          makepkg -s
      register: hyprland_rebuild_outcome
      changed_when: no

    - name: Install rebuilt Hyprland
      community.general.pacman:
        name: "{{ item }}"
        state: present
      become: true
      loop:
        - "{{ ansible_user_dir }}/hyprland_rebuild/hyprland-0.45.0-1-x86_64.pkg.tar.zst"
      register: hyprland_reinstall_outcome

  always:
    - name: Update hyprpm package list
      command: hyprpm update
      ignore_errors: yes
      register: hyprpm_update_outcome
      changed_when: no
